<Breadcrumb @crumb={{hash label=this.policy.name args=(array "policies.policy" this.policy.name)}} />

{{page-title "Policy"}}
<section class="section">
	<h1 class="title with-flex" data-test-title>
		<div>
			{{this.policy.name}}
		</div>
		{{#if (can "destroy policy")}}
			<div>
				<TwoStepButton
					data-test-delete-button
					@idleText="Delete"
					@cancelText="Cancel"
					@confirmText="Yes, delete"
					@confirmationMessage="Are you sure?"
					@awaitingConfirmation={{this.deletePolicy.isRunning}}
					@onConfirm={{perform this.deletePolicy}}
					@onPrompt={{this.onDeletePrompt}}
					@onCancel={{this.onDeleteCancel}}
				/>
			</div>
		{{/if}}
	</h1>
	<PolicyEditor
		@policy={{this.policy}}
	/>

	<hr />
	<section class="create-test-token">
		<div class="title with-flex is-2">
			<h2 class="title">Create a test token for this policy</h2>
			<button
				class="button is-primary"
				data-test-create-test-token
				{{on "click" (perform this.createTestToken)}}
				>Create Test Token</button>
		</div>
		<p class="is-info">Create a test token that expires in 10 minutes for testing purposes.</p>
		<p>When you're ready to create more tokens, you can do so in your terminal with
			<pre><code>nomad acl token create -name="&lt;TOKEN_NAME&gt;" -policy={{this.policy.name}} -type=client -ttl=&lt;8h&gt;</code></pre>
		</p>
	</section>

	<hr />
	<h1 class="title">
		Tokens for {{this.policy.name}}
	</h1>
  {{#if this.tokens.length}}
    <ListTable
      @source={{this.tokens}}
      @class="tokens" as |t|>
      <t.head>
        <th>Name</th>
        <th>Created</th>
				<th>Expires</th>
				<th>Extend</th>
				<th>Delete</th>
      </t.head>
      <t.body as |row|>
        <tr>
          <td>
						<Tooltip @text={{row.model.id}}>
							{{row.model.name}}
						</Tooltip>
					</td>
          <td>
						{{moment-from-now row.model.createTime interval=1000}}
					</td>
					<td>
						{{#if row.model.expirationTime}}
							<Tooltip @text={{row.model.expirationTime}}>
								<span class="{{if row.model.isExpired "has-text-danger"}}">{{moment-from-now row.model.expirationTime interval=1000}}</span>
							</Tooltip>
						{{else}}
							<span class="has-text-grey">Never</span>
						{{/if}}
					</td>
					<td>
						{{#if row.model.expirationTime}}
							{{#if row.model.isExpired}}
								<span class="has-text-grey">Expired</span>
							{{else}}
								<TwoStepButton
									@idleText="Extend by 8 hours"
									@cancelText="Cancel"
									@confirmText="Yes, extend"
									@confirmationMessage="Are you sure?"
									@awaitingConfirmation={{row.model.isPendingExtension}}
									@onConfirm={{perform this.extendToken row.model}}
									@classes={{hash
										idleButton="is-info"
										confirmButton="is-info"
									}}
								/>
							{{/if}}
						{{else}}
							<span class="has-text-grey">N/A</span>
						{{/if}}
					</td>
					<td>
						<TwoStepButton
							@idleText="Delete"
							@cancelText="Cancel"
							@confirmText="Yes, delete"
							@confirmationMessage="Are you sure?"
							@awaitingConfirmation={{row.model.isPendingDeletion}}
							@onConfirm={{perform this.deleteToken row.model}}
							@classes={{hash
								idleButton="is-danger"
								confirmButton="is-danger"
							}}
						/>
					</td>
        </tr>
      </t.body>
    </ListTable>
	{{else}}
		<div class="empty-message">
			<h3 data-test-empty-policies-list-headline class="empty-message-headline">
				No Tokens
			</h3>
			<p class="empty-message-body">
				No tokens are using this policy.
			</p>
		</div>
	{{/if}}
</section>

{{outlet}}